sudo: required

services:
- docker
- heroku

env:
  global:
  - secure: NqQ/yNyGuPHP1u/1kLcUMyuv/QaXv1tzLv5KFindZFiPflGQEtl37x/atVE2uxfPvQT0uYfvqpPSag+fXfCQzhY1adKNqQAkbPzoUhaASncohpOTTT6KF5eBwn8cu5n0hwPEyhtKsJNTzza9OuDwFOdxpLCmey2gu3NihhWMcEkimTXTZu+T8CBYE4lqRqAzRr38XFKq+uCdYvLewY2S2phpjYo3uBGgXqu4jGdCMIB5Xnw54CYXZVOuVKoAzq7Qij0kRePWW9NJqw6fJDKmxi2T0vXKUxMk0LslUUk9pXe2KFNLk8rYeHQwIVnfzqWLFAtE4QkqnXLwcTIYTA4yrU3Hh1bvfnzD5DPRYV7Hk5rSnUdtBq8qUZcKQMHV1Ln+idxVSENJ1N1zQcvs2zgU/I7JqTFbf3ksW72auA9+P3jwS3NyYud9TFhtNV4aGlaVE6dpiKO0wiTuPyO5NuwHP1w50q7H6y68fvovHyAsYQdTQcy5VQRmE+jbVixMW0XMoxooYHT3DvhsOMPcHWzmSHvsZgnhSPrYV4odyHOQCoqNPZxtqmVslVvl6U0lS2t0vw79AjV/RRREvo/FGLVkp3/h04S/QnKBAsGdtZEcwVqWHou1yn11b76pA2Fn01aCTJDusMwolMLgK+1p6nPJJE4aW5OgEK4QTy8UXxTjBAQ=
  - secure: d87Pk70HiQy1E5igI/08VjbMefJQnFu6Dj6J3iFHq+rJc9RILgLgi0nLXUGfaUbuw1Koa5MivUMMabnVbam40CODbm0Jm1I9mHH4+RvKvZyTcLj+hJALsvFEWF/gZb+TI5/HYZCMc4mUqN/9af1ba8XP2EQkazdKuvC/AEnMrToDVEhdsFCczVTo0cZVspljXuVPcUKYXoFyIcvW7jtUD0Ax2Y+54BH3a8qyQcqefGF6Rj01SEPM1mVQw6yn4s9rzqQ4kciWcZF/CxVitGuN3H3b+izk9tl7wwzU6+FTbmbtFfoodW+528ChebRjlHnoi4eJlsQgcpM+j3W3dJrJc6ouW74sSBJFbVw4nZUp/Lk52xRXQZ7a4eM5k3TpgI/ggF7IkcBCgxHaHpY2WmEfopUlZfUvmS3dY4kJtvBVTRwNiHw4Ozirz7yLPOGHOaQN3OqFDKEPnOR6kfEv3ZOAMcTJbf/Ixo7iHmvMJMr48YXhccP8ive0/jiBZjqvSe07ERSZPnZNqVJ+CSTzwF/frOvSkHhog70gkYCuDwGp/0e4UUZaHniH0HKb2T4mWmI4yMt0LyHbiJa6v5kLf0IkpSNSuWEfoXQyFxieKpvjKVu+SZkZ2rJPP8ytA+1aTBkPkxp9eZRbcLpH8nwrnXtOgkK0i+ct0LL47ybo6u3Rx/A=

before_install:
- scripts/update_docker.sh
- docker run -it -v "$(pwd)":/usr/app -w /usr/app r3ddox/node-pdftk:10.13.0 npm ci

before_script: docker run -it -v "$(pwd)":/usr/app -w /usr/app --env-file <(env | grep TRAVIS) r3ddox/node-pdftk:10.13.0 sh -c "npm i -g greenkeeper-lockfile && greenkeeper-lockfile-update"

after_script: docker run -it -v "$(pwd)":/usr/app -w /usr/app --env GH_TOKEN=$GH_TOKEN --env-file <(env | grep TRAVIS) r3ddox/node-pdftk:10.13.0 sh -c "npm i -g greenkeeper-lockfile && greenkeeper-lockfile-upload"

script:
- docker run -it -v "$(pwd)":/usr/app -w /usr/app r3ddox/node-pdftk:10.13.0 npm test

deploy:
- provider: script
  script: scripts/deploy-staging.sh $HEROKU_TOKEN
  skip_cleanup: true
  on:
    branch: develop
- provider: script
  script: scripts/deploy.sh $HEROKU_TOKEN
  skip_cleanup: true
  on:
    tags: true
